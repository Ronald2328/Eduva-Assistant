# 8.1 Arquitectura Completa del Sistema

## Diagrama de Arquitectura General

```mermaid
graph TB
    subgraph "Usuario Final"
        U[Usuario WhatsApp<br/>üì±]
    end

    subgraph "Gateway WhatsApp - Railway"
        E[Evolution API<br/>üîå]
        PG[(PostgreSQL<br/>üíæ Sesiones)]
        R[(Redis<br/>‚ö° Cache)]

        E --> PG
        E --> R
    end

    subgraph "Backend - Railway"
        API[FastAPI Server<br/>üöÄ]
        LG[LangGraph Agent<br/>ü§ñ]
        SEARCH[SearchDocuments<br/>Service üîç]
    end

    subgraph "Servicios IA"
        GPT[OpenAI GPT-4o-mini<br/>üß†]
        EMB[OpenAI Embeddings<br/>text-embedding-3-small<br/>üìä]
    end

    subgraph "Almacenamiento"
        MONGO[(MongoDB Atlas<br/>üìö Vector Search)]
    end

    subgraph "Monitoreo"
        LOG[Logfire<br/>üìà Observabilidad]
    end

    %% Flujo principal
    U -->|1. Env√≠a mensaje| E
    E -->|2. Webhook POST| API
    API -->|3. Parse & Route| LG

    LG -->|4. Chat completion| GPT
    LG -->|5. Tool: search_documents| SEARCH

    SEARCH -->|6. Genera embedding| EMB
    SEARCH -->|7. Vector Search| MONGO
    MONGO -->|8. Top p√°ginas relevantes| SEARCH
    SEARCH -->|9. Contexto| LG

    GPT -->|10. Respuesta AI| LG
    LG -->|11. Respuesta final| API
    API -->|12. Send message| E
    E -->|13. Entrega| U

    %% Telemetr√≠a
    API -.->|Telemetr√≠a| LOG
    LG -.->|Telemetr√≠a| LOG
    SEARCH -.->|Telemetr√≠a| LOG

    %% Estilos
    style U fill:#25D366,color:#fff
    style E fill:#FF6B6B,color:#fff
    style PG fill:#336791,color:#fff
    style R fill:#DC382D,color:#fff
    style API fill:#4ECDC4,color:#fff
    style LG fill:#95E1D3
    style SEARCH fill:#F7DC6F
    style GPT fill:#A8E6CF
    style EMB fill:#A8E6CF
    style MONGO fill:#FFD93D
    style LOG fill:#C5A3FF,color:#fff
```

---

## Componentes del Sistema

### 1. Usuario Final
- **WhatsApp**: Interfaz de usuario
- **Dispositivo**: M√≥vil o web
- **Interacci√≥n**: Env√≠o de mensajes de texto

### 2. Gateway WhatsApp (Evolution API)
- **Evolution API**: Gateway REST para WhatsApp
- **PostgreSQL**: Almacenamiento de sesiones y configuraciones
- **Redis**: Cache en memoria y cola de mensajes
- **Hosting**: Railway (Docker)

### 3. Backend (FastAPI + LangGraph)
- **FastAPI**: Framework web as√≠ncrono
- **LangGraph Agent**: Orquestador conversacional
- **SearchDocuments Service**: Pipeline de b√∫squeda
- **Hosting**: Railway (Python)

### 4. Servicios de IA
- **OpenAI GPT-4o-mini**: Generaci√≥n de respuestas
- **OpenAI Embeddings**: Vectorizaci√≥n de textos
- **API**: REST over HTTPS

### 5. Almacenamiento
- **MongoDB Atlas**: Base de datos NoSQL con Vector Search
- **Cloud**: MongoDB Cloud (multi-regi√≥n)

### 6. Monitoreo
- **Logfire**: Observabilidad y telemetr√≠a
- **Cloud**: Pydantic Logfire

---

## Flujo de Datos Completo

### Paso 1-3: Recepci√≥n
```
Usuario ‚Üí WhatsApp Servers ‚Üí Evolution API ‚Üí FastAPI Webhook
```

### Paso 4-5: An√°lisis
```
FastAPI ‚Üí LangGraph Agent ‚Üí OpenAI GPT-4o-mini
                         ‚Üì
                   ¬øNecesita buscar info?
                         ‚Üì
              Tool: search_documents
```

### Paso 6-8: B√∫squeda
```
SearchDocuments ‚Üí OpenAI Embeddings ‚Üí Vector [1536 dims]
                                          ‚Üì
                                  MongoDB Vector Search
                                          ‚Üì
                                  Top 5 p√°ginas relevantes
```

### Paso 9-11: Generaci√≥n
```
P√°ginas relevantes ‚Üí LangGraph Agent ‚Üí OpenAI GPT-4o-mini
                                            ‚Üì
                                    Respuesta contextualizada
```

### Paso 12-13: Respuesta
```
LangGraph ‚Üí FastAPI ‚Üí Evolution API ‚Üí WhatsApp ‚Üí Usuario
```

---

## Diagrama de Secuencia Detallado

```mermaid
sequenceDiagram
    participant U as Usuario
    participant WA as WhatsApp
    participant EV as Evolution API
    participant PG as PostgreSQL
    participant RD as Redis
    participant FA as FastAPI
    participant LG as LangGraph
    participant SD as SearchDocuments
    participant OE as OpenAI Embeddings
    participant MG as MongoDB
    participant GP as GPT-4o-mini
    participant LF as Logfire

    U->>WA: Env√≠a "¬øCu√°nto cuesta la matr√≠cula?"
    WA->>EV: Entrega mensaje
    EV->>PG: Verifica sesi√≥n activa
    PG-->>EV: Sesi√≥n v√°lida
    EV->>RD: Check rate limit
    RD-->>EV: OK
    EV->>FA: POST /webhook (mensaje)
    FA->>LF: Log: Webhook recibido
    FA->>FA: Parse mensaje
    FA->>LG: Invocar agente
    LG->>GP: "¬øCu√°nto cuesta la matr√≠cula?" + System Prompt
    GP->>GP: Analiza query
    GP-->>LG: tool_call: search_documents(query, school)
    LG->>SD: Ejecutar search_documents
    SD->>MG: get_documents_by_school("Inform√°tica")
    MG-->>SD: Lista de documentos
    SD->>GP: Seleccionar mejor documento
    GP-->>SD: "Reglamento de Pagos 2024"
    SD->>OE: Generar embedding(query)
    OE-->>SD: Vector [1536 dims]
    SD->>MG: Vector Search (documento + embedding)
    MG-->>SD: Top 5 p√°ginas (score > 0.8)
    SD->>GP: Generar respuesta (query + p√°ginas)
    GP-->>SD: "La matr√≠cula cuesta S/ 350..."
    SD-->>LG: SearchDocumentsResponse
    LG->>GP: Continuar conversaci√≥n
    GP-->>LG: Respuesta final
    LG-->>FA: {"messages": [AIMessage(...)]}
    FA->>LF: Log: Respuesta generada
    FA->>EV: send_message(phone, respuesta)
    EV->>RD: Encolar mensaje
    RD-->>EV: OK
    EV->>WA: Enviar mensaje
    WA->>U: "Seg√∫n el Reglamento de Pagos..."
    FA->>LF: Log: Mensaje enviado
```

---

## Infraestructura en Railway

```mermaid
graph TB
    subgraph "Railway Project: Science Bot"
        subgraph "Services"
            APP[ScienceBotUNP<br/>FastAPI<br/>Port: 8000]
            EVO[evolution-api<br/>Evolution API<br/>Port: 8080]
            DB[(postgres<br/>PostgreSQL<br/>Port: 5432)]
            CACHE[(redis<br/>Redis<br/>Port: 6379)]
        end

        subgraph "Internal Network"
            APP -.->|HTTP| EVO
            EVO -.->|SQL| DB
            EVO -.->|Cache| CACHE
        end

        subgraph "Public Endpoints"
            PUB1[sciencebotunp-production.up.railway.app]
            PUB2[evolution-api-production-be18.up.railway.app]
        end
    end

    subgraph "External Services"
        GH[GitHub<br/>Auto Deploy]
        OAI[OpenAI API]
        MDB[MongoDB Atlas]
        LGF[Logfire]
    end

    GH -->|CI/CD| APP
    GH -->|CI/CD| EVO
    APP --> OAI
    APP --> MDB
    APP --> LGF
    PUB1 -.-> APP
    PUB2 -.-> EVO

    style APP fill:#4ECDC4
    style EVO fill:#FF6B6B
    style DB fill:#336791
    style CACHE fill:#DC382D
```

---

## Stack Tecnol√≥gico Completo

### Frontend
- WhatsApp (usuario final)

### Gateway
- Evolution API (WhatsApp Business API alternativo)
- Baileys (librer√≠a WhatsApp Web Protocol)

### Backend
- Python 3.12
- FastAPI (framework web)
- LangGraph (orquestador de agentes)
- LangChain (integraciones IA)
- Pydantic (validaci√≥n de datos)

### IA
- OpenAI GPT-4o-mini (chat completion)
- OpenAI text-embedding-3-small (embeddings)

### Bases de Datos
- MongoDB Atlas (Vector Search)
- PostgreSQL (Evolution API)
- Redis (cache Evolution API)

### Deployment
- Railway (PaaS)
- Docker (containerizaci√≥n)
- GitHub Actions (CI/CD impl√≠cito)

### Monitoreo
- Logfire (observabilidad)
- Railway Dashboard (m√©tricas)

---

## Patrones de Arquitectura

### 1. **Microservicios**
- Evolution API y FastAPI son servicios independientes
- Comunicaci√≥n via HTTP REST
- Cada servicio con su base de datos

### 2. **Event-Driven**
- Webhooks de Evolution API
- Sistema reactivo a eventos de WhatsApp

### 3. **RAG (Retrieval-Augmented Generation)**
- B√∫squeda vectorial en MongoDB
- Generaci√≥n de respuestas con contexto

### 4. **Agent Pattern**
- LangGraph como orquestador
- Tools (search_documents)
- Decisiones din√°micas del LLM

---

## Escalabilidad

### Horizontal
- **FastAPI**: M√∫ltiples r√©plicas en Railway
- **MongoDB**: Sharding autom√°tico en Atlas
- **Redis**: Cluster mode (si es necesario)

### Vertical
- **Railway**: Aumentar CPU/RAM por servicio
- **MongoDB Atlas**: Tier superior (M10, M20, etc.)

### L√≠mites Actuales
- **Evolution API**: ~100 mensajes/minuto (rate limit WhatsApp)
- **OpenAI**: ~10,000 tokens/minuto (tier 1)
- **MongoDB**: ~100 queries/segundo (M0 tier)

---

## Seguridad

### Autenticaci√≥n
- Evolution API: API Key en header
- OpenAI: API Key
- MongoDB: Usuario/password + whitelist IP

### Encriptaci√≥n
- HTTPS en todos los endpoints
- TLS para conexiones a bases de datos
- Variables de entorno para secrets

### Privacidad
- No se almacenan mensajes de usuarios
- Solo metadata temporal en Redis
- MongoDB solo tiene documentos acad√©micos p√∫blicos

---

## Pr√≥ximos Pasos

- **[8.2 Flujo de Mensaje](./8.2-flujo-mensaje.md)**: Diagrama de secuencia detallado
- **[8.3 Grafo LangGraph](./8.3-grafo-langgraph.md)**: Visualizaci√≥n del agente

**Volver al √≠ndice**: [../README.md](../README.md)

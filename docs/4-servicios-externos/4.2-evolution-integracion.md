# 4.2 Evolution API - Integración Técnica

## Clase EvolutionAPIService

```python
# app/services/evolution_service.py

class EvolutionAPIService:
    """Service for interacting with Evolution API."""

    def __init__(self) -> None:
        self.base_url: str = settings.EVOLUTION_API_URL
        self.api_key: str = settings.EVOLUTION_API_KEY

    def _format_phone_number(self, phone_number: str) -> str:
        """Remove non-digits from phone number."""
        return re.sub(pattern=r"[^\d]", repl="", string=phone_number)

    def _get_headers(self) -> dict[str, str]:
        """Get headers for Evolution API requests."""
        return {
            "apikey": self.api_key,
            "Content-Type": "application/json",
        }

    async def send_message(
        self, phone_number: str, message: str, instance_name: str
    ) -> SendMessageResponse:
        """Send text message to WhatsApp number."""
        pass

    async def send_presence(
        self, phone_number: str, instance_name: str, state: str = "composing", delay: int = 3000
    ) -> PresenceResponse:
        """Send presence status (typing, recording, etc)."""
        pass

    async def mark_message_as_read(
        self, phone_number: str, instance_name: str, message_id: str
    ) -> ReadMessageResponse:
        """Mark message as read in WhatsApp."""
        pass

    def parse_webhook_message(
        self, webhook_payload: WebhookPayload
    ) -> ParsedMessage | None:
        """Parse incoming webhook message."""
        pass

# Global instance
evolution_service = EvolutionAPIService()
```

---

## Métodos Principales

### 1. send_message

```http
POST /message/sendText/{instance_name}
apikey: your_api_key

{
  "number": "51999999999",
  "text": "Respuesta del bot"
}
```

### 2. send_presence

```http
POST /chat/sendPresence/{instance_name}
apikey: your_api_key

{
  "number": "51999999999",
  "presence": "composing",
  "delay": 3000
}
```

### 3. mark_message_as_read

```http
POST /chat/markMessageAsRead/{instance_name}
apikey: your_api_key

{
  "readMessages": [{
    "remoteJid": "51999999999@s.whatsapp.net",
    "id": "message_id",
    "fromMe": false
  }]
}
```

---

## Formato de Números

```python
def _format_phone_number(self, phone_number: str) -> str:
    return re.sub(pattern=r"[^\d]", repl="", string=phone_number)

# Ejemplos:
# "+51 999 999 999" → "51999999999"
# "(999) 999-999" → "999999999"
```

---

## Headers y Autenticación

```python
def _get_headers(self) -> dict[str, str]:
    return {
        "apikey": self.api_key,
        "Content-Type": "application/json",
    }
```

**Autenticación**: API Key en header `apikey`.

---

## Manejo de Errores HTTP

```python
async def send_message(...):
    async with httpx.AsyncClient() as client:
        try:
            response = await client.post(url=url, json=payload, headers=self._get_headers())
            response.raise_for_status()  # Lanza excepción si status >= 400

            return SendMessageResponse(error=False, message="Success")

        except httpx.HTTPError as e:
            return SendMessageResponse(error=True, message=str(e))
```

**Errores comunes**:
- `401 Unauthorized`: API Key inválida
- `404 Not Found`: Instancia no existe
- `429 Too Many Requests`: Rate limit
- `500 Internal Server Error`: Error en Evolution API

---

**Volver al índice**: [../README.md](../README.md)

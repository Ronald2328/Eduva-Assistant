# 2.7 Railway

## ¿Qué es Railway?

**Railway** es una **plataforma PaaS** (Platform as a Service) que simplifica el deployment de aplicaciones y bases de datos con integración directa a GitHub.

### Características Principales

- **Deploy automático**: Push a GitHub → Deploy automático
- **Variables de entorno**: Gestión centralizada de secrets
- **Múltiples servicios**: Un proyecto puede tener varios servicios (app, DB, cache)
- **Networking interno**: Comunicación entre servicios sin exposición pública
- **Monitoreo**: Logs, métricas y alertas incluidos

---

## ¿Por qué Railway?

| Railway | Heroku | Render | Vercel | AWS |
|---------|--------|--------|--------|-----|
| **Setup** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐ |
| **Precio** | $5/mes | $7/mes (Eco) | $7/mes | Gratis (Hobby) | Variable |
| **Databases** | ✅ Incluidas | ⚠️ Add-ons | ✅ Incluidas | ❌ | ✅ Complejas |
| **Docker** | ✅ | ✅ | ✅ | ⚠️ Limitado | ✅ |
| **CI/CD** | ✅ Automático | ✅ | ✅ | ✅ | ⚠️ Manual |
| **Networking** | ✅ Internal | ⚠️ Limitado | ⚠️ Limitado | ✅ | ✅ |

**Railway es ideal para**:
- Proyectos con múltiples servicios (app + DB)
- Equipos pequeños/medianos
- Prototipado rápido
- Apps con Docker

---

## Arquitectura del Proyecto en Railway

```mermaid
graph TB
    subgraph "Railway Project: Science Bot"
        A[ScienceBotUNP<br/>FastAPI]
        B[evolution-api<br/>Evolution API]
        C[(postgres<br/>PostgreSQL)]
        D[(redis<br/>Redis)]
    end

    E[GitHub Repo] -->|Auto Deploy| A
    E -->|Auto Deploy| B

    B --> C
    B --> D

    A -->|HTTP| B
    B -->|Webhooks| A

    F[Usuario WhatsApp] -->|Mensajes| B

    style A fill:#4ECDC4
    style B fill:#FF6B6B
    style C fill:#336791
    style D fill:#DC382D
```

### Servicios en Railway

1. **ScienceBotUNP** (FastAPI)
   - App principal del bot
   - Deploy desde GitHub
   - Expuesto públicamente para webhooks

2. **evolution-api** (Evolution API)
   - Gateway de WhatsApp
   - Deploy desde Docker Image
   - Expuesto públicamente

3. **postgres** (PostgreSQL)
   - Base de datos de Evolution API
   - Solo accesible internamente
   - Backup automático

4. **redis** (Redis)
   - Cache de Evolution API
   - Solo accesible internamente
   - Sin persistencia externa

---

## Configuración del Proyecto

### 1. **Crear Proyecto**

```bash
# Desde Railway Dashboard
New Project → Deploy from GitHub Repo → Seleccionar repositorio
```

### 2. **Agregar Servicios**

```bash
# Agregar PostgreSQL
+ New → Database → PostgreSQL

# Agregar Redis
+ New → Database → Redis

# Agregar Evolution API
+ New → Docker Image → atendai/evolution-api:latest
```

### 3. **Configurar Variables de Entorno**

Railway inyecta automáticamente variables para servicios internos:

```bash
# Variables generadas automáticamente
PGHOST=postgres.railway.internal
PGPORT=5432
PGUSER=postgres
PGPASSWORD=<auto-generated>
PGDATABASE=railway

REDIS_URL=redis://default:<password>@redis.railway.internal:6379
```

---

## Variables de Entorno del Proyecto

### ScienceBotUNP (FastAPI)

```bash
# Aplicación
APP_NAME=ScienceBot WhatsApp API
APP_VERSION=1.0.0
ENVIRONMENT=production

# Evolution API
EVOLUTION_API_URL=https://evolution-api-production-be18.up.railway.app
EVOLUTION_API_KEY=<secret>

# OpenAI
OPENAI_API_KEY=sk-proj-...
OPENAI_MODEL=gpt-4o-mini
OPENAI_EMBEDDING_MODEL=text-embedding-3-small

# MongoDB Atlas (externo)
MONGO_URL=mongodb+srv://user:pass@cluster.mongodb.net
MONGO_DATABASE=ScienceBot

# Monitoreo
LOGFIRE_TOKEN=<optional>
```

### evolution-api (Evolution API)

```bash
# Base de datos
DATABASE_URL=postgresql://postgres:pass@postgres.railway.internal:5432/evolution
DATABASE_PROVIDER=postgresql

# Redis
REDIS_URL=redis://default:pass@redis.railway.internal:6379
REDIS_ENABLED=true

# API
SERVER_URL=https://evolution-api-production-be18.up.railway.app
AUTHENTICATION_API_KEY=<secret>

# Webhooks
WEBHOOK_GLOBAL_URL=https://sciencebotunp-production.up.railway.app/webhook
WEBHOOK_GLOBAL_ENABLED=true
```

---

## Networking Interno

Railway permite comunicación entre servicios usando **dominios internos**:

```bash
# Dominio interno (solo accesible dentro del proyecto)
postgres.railway.internal:5432
redis.railway.internal:6379

# Dominio público (accesible desde internet)
sciencebotunp-production.up.railway.app
evolution-api-production-be18.up.railway.app
```

**Ventajas**:
- No exponer bases de datos públicamente
- Comunicación rápida (mismo data center)
- Sin cargos de egress

```mermaid
graph LR
    A[FastAPI] -->|Internal Network| B[Evolution API]
    B -->|Internal| C[(PostgreSQL)]
    B -->|Internal| D[(Redis)]

    E[Internet] -->|Public| A
    E -->|Public| B

    style C fill:#336791
    style D fill:#DC382D
```

---

## CI/CD Automático

### Flujo de Deployment

```mermaid
sequenceDiagram
    participant D as Developer
    participant G as GitHub
    participant R as Railway
    participant S as Service

    D->>G: git push main
    G->>R: Webhook (nuevo commit)
    R->>R: Build Docker Image
    R->>R: Run Tests (opcional)
    R->>S: Deploy nueva versión
    S->>S: Health check
    R->>D: ✅ Deploy exitoso
```

**Pasos automáticos**:
1. Detecta push a `main`
2. Clona el repositorio
3. Detecta `Dockerfile` o `pyproject.toml`
4. Construye la imagen
5. Ejecuta la aplicación
6. Verifica health check
7. Cambia tráfico a nueva versión

### Health Check

Railway hace health checks para verificar que el servicio está vivo:

```python
# app/routes/health.py

@router.get("/health")
async def health_check() -> HealthResponse:
    """Railway llama este endpoint cada 30s."""
    return HealthResponse(status="healthy", service="ScienceBot WhatsApp API")
```

**Configuración de Health Check**:
- **Endpoint**: `/health`
- **Intervalo**: 30 segundos
- **Timeout**: 10 segundos
- **Reintentos**: 3 fallos consecutivos → Reinicia servicio

---

## Logs y Monitoreo

### Ver Logs en Tiempo Real

```bash
# Desde Railway Dashboard
Service → Logs → Ver stream en tiempo real
```

**Tipos de logs**:
- **Build logs**: Construcción de imagen Docker
- **Deploy logs**: Deployment del servicio
- **Application logs**: Logs de tu app (print, logging)

### Métricas

Railway muestra métricas automáticamente:

1. **CPU Usage**: % de CPU usado
2. **Memory Usage**: RAM usada / asignada
3. **Network**: Tráfico de entrada/salida
4. **Disk**: Almacenamiento usado

```mermaid
graph TB
    A[Railway Dashboard]

    subgraph "Métricas"
        B[CPU: 15%]
        C[RAM: 450 MB / 1 GB]
        D[Network: 5 MB/s]
    end

    A --> B
    A --> C
    A --> D
```

---

## Dockerfile del Proyecto

```dockerfile
# Dockerfile para FastAPI

FROM python:3.12-slim

WORKDIR /app

# Instalar uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copiar dependencias
COPY pyproject.toml uv.lock ./

# Instalar dependencias
RUN uv sync --frozen --no-cache

# Copiar código
COPY . .

# Exponer puerto
EXPOSE 8000

# Comando de inicio
CMD ["uv", "run", "fastapi", "run", "app/main.py", "--host", "0.0.0.0", "--port", "8000"]
```

**Railway detecta automáticamente**:
- Dockerfile presente → Usa Docker build
- pyproject.toml → Usa Python buildpack
- package.json → Usa Node.js buildpack

---

## Escalamiento

### Escalamiento Vertical

```bash
# Aumentar recursos del servicio
Service Settings → Resources
- Shared CPU (gratis)
- 1 vCPU + 1 GB RAM ($5/mes)
- 2 vCPU + 2 GB RAM ($10/mes)
- 4 vCPU + 4 GB RAM ($20/mes)
```

### Escalamiento Horizontal (Réplicas)

```bash
# Múltiples instancias del mismo servicio
Service Settings → Replicas → 2 instances
```

**Load balancing automático** entre réplicas.

---

## Backups

### PostgreSQL

Railway hace backup automático:
- **Frecuencia**: Diaria
- **Retención**: 7 días (plan Pro)
- **Ubicación**: S3 interno de Railway

### Redis

⚠️ **Sin backups automáticos** (datos volátiles)

### Application Data

⚠️ **Sin volúmenes persistentes** por defecto. Usa S3 o similar para archivos.

---

## Costos

### Ejemplo de Facturación

```
Proyecto "Science Bot":

ScienceBotUNP (FastAPI):
- Compute: $5/mes (1 vCPU + 1 GB RAM)
- Egress: $0.10/GB (~$1/mes)

evolution-api:
- Compute: $5/mes (1 vCPU + 1 GB RAM)
- Egress: $0.10/GB (~$1/mes)

PostgreSQL:
- Storage: $0.20/GB (~$0.50/mes para 2.5 GB)
- Compute: $5/mes

Redis:
- Storage: $0.20/GB (~$0.10/mes para 500 MB)
- Compute: $5/mes

TOTAL: ~$22.60/mes
```

**Optimizaciones**:
- Usar Shared CPU para desarrollo ($0)
- Limitar logs (reduce storage)
- Usar dominios internos (sin egress)

---

## Ventajas de Railway

1. **Setup rápido**: Deploy en minutos
2. **CI/CD incluido**: Git push → Deploy automático
3. **Bases de datos incluidas**: PostgreSQL, Redis, MySQL, MongoDB
4. **Networking interno**: Comunicación segura entre servicios
5. **Monitoreo**: Logs y métricas out-of-the-box
6. **Variables de entorno**: Gestión centralizada
7. **Rollbacks fáciles**: Volver a versión anterior con 1 click

---

## Limitaciones

1. **Costo**: Más caro que cloud tradicional (AWS/GCP) a escala
2. **Vendor lock-in**: Migrar fuera de Railway requiere esfuerzo
3. **Sin Kubernetes**: Si necesitas K8s, usa GCP/AWS
4. **Regiones limitadas**: Solo US y EU (latencia para LATAM)

---

## Alternativas a Railway

| Plataforma | Mejor para | Precio |
|------------|-----------|--------|
| **Railway** | Proyectos pequeños/medianos | $5-50/mes |
| **Heroku** | Proyectos legacy | $7-500/mes |
| **Render** | Similar a Railway | $7-100/mes |
| **Vercel** | Frontend + Serverless | Gratis-$20/mes |
| **AWS** | Empresas grandes | Variable (complejo) |
| **DigitalOcean** | VPS tradicional | $5-40/mes |

---

## Recursos Adicionales

- [Railway Docs](https://docs.railway.app/)
- [Railway Templates](https://railway.app/templates)
- [Railway Pricing](https://railway.app/pricing)

---

## Próximos Pasos

- **[7.1 Railway Setup](../7-deployment/7.1-railway-setup.md)**: Guía de configuración paso a paso
- **[7.2 Variables de Entorno](../7-deployment/7.2-variables-entorno.md)**: Lista completa de variables

**Volver al índice**: [README](../README.md)

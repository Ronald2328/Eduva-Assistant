# 7.3 Monitoreo

## Logfire para Observabilidad

```python
# app/main.py

if settings.LOGFIRE_TOKEN:
    logfire.configure(
        service_name=settings.APP_NAME,
        environment=settings.ENVIRONMENT.value,
        token=settings.LOGFIRE_TOKEN,
    )

    logfire.instrument_fastapi(app)      # ⭐ Instrumentar FastAPI
    logfire.instrument_httpx()           # ⭐ Instrumentar HTTP calls
    logfire.instrument_openai()          # ⭐ Instrumentar OpenAI
```

---

## Instrumentación Automática

### FastAPI

Captura automáticamente:
- Todos los requests (método, path, status)
- Response time
- Errores y excepciones
- Headers y query params

### HTTPX

Captura:
- HTTP calls a Evolution API
- Latencia de requests
- Status codes
- Errores de red

### OpenAI

Captura:
- Prompts enviados
- Respuestas generadas
- Tokens usados (input/output)
- Latencia de requests
- Costos estimados

---

## Métricas Importantes

### 1. Request Latency

```
/webhook endpoint:
- p50: 2.5s
- p95: 4.0s
- p99: 6.0s
```

### 2. Error Rate

```
Total requests: 1000
Errors: 5
Error rate: 0.5%
```

### 3. OpenAI Tokens

```
Input tokens: 50,000
Output tokens: 20,000
Estimated cost: $0.08
```

### 4. Vector Search Performance

```
Average query time: 100ms
Queries/hour: 500
```

---

## Debugging en Producción

### Ver Trace de Request

Logfire muestra trace completo:

```
Request /webhook
  ├─ Parse webhook (5ms)
  ├─ LangGraph.ainvoke (4200ms)
  │   ├─ chat node (800ms)
  │   │   └─ OpenAI GPT-4 (750ms)
  │   ├─ tools node (2500ms)
  │   │   └─ search_documents (2500ms)
  │   │       ├─ Get documents (50ms)
  │   │       ├─ Select document (800ms)
  │   │       ├─ Vector Search (100ms)
  │   │       └─ Generate answer (1500ms)
  │   └─ chat node (900ms)
  │       └─ OpenAI GPT-4 (850ms)
  └─ Send response (100ms)
```

---

## Alertas y Logs

### Configurar Alertas

```python
# En Logfire Dashboard:
# - Error rate > 5% → Email alert
# - p95 latency > 10s → Slack notification
# - OpenAI cost > $10/day → Email alert
```

### Logs en Railway

```bash
# Railway Dashboard → Service → Logs

[INFO] Starting server...
[INFO] Webhook received: messages.upsert
[INFO] Processing message from 51999999999
[INFO] LangGraph response generated
[INFO] Message sent successfully
```

---

## Recursos Adicionales

- [Logfire Documentation](https://logfire.pydantic.dev/docs/)
- [Railway Logs](https://docs.railway.app/guides/logs)

**Volver al índice**: [../README.md](../README.md)

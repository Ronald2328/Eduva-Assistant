# 2.2 PostgreSQL

## ¿Qué es PostgreSQL?

**PostgreSQL** (también llamado "Postgres") es un **sistema de gestión de bases de datos relacional** (RDBMS) de código abierto, considerado uno de los más avanzados y confiables del mundo.

### Características Principales

- **ACID Compliant**: Garantiza transacciones confiables
- **Relacional**: Tablas con relaciones (foreign keys)
- **Extensible**: Soporta tipos de datos personalizados
- **Performance**: Optimizado para consultas complejas
- **Open Source**: Gratis y con comunidad activa

---

## ¿Por qué Evolution API usa PostgreSQL?

Evolution API necesita **almacenamiento persistente** para:

1. **Sesiones de WhatsApp**: Credenciales y tokens de autenticación
2. **Configuraciones de instancias**: Settings por cada número conectado
3. **Historial de mensajes**: Log de mensajes enviados/recibidos
4. **Webhooks**: URLs y eventos configurados
5. **Metadatos**: Información de contactos, grupos, etc.

```mermaid
graph TB
    A[Evolution API] -->|Store/Retrieve| B[(PostgreSQL)]

    subgraph "Datos Almacenados"
        C[Sesiones de WhatsApp]
        D[Configuración de Instancias]
        E[Historial de Mensajes]
        F[Webhooks]
        G[Contactos y Grupos]
    end

    B --> C
    B --> D
    B --> E
    B --> F
    B --> G

    style A fill:#FF6B6B
    style B fill:#336791
```

---

## ¿Qué Almacena PostgreSQL para Evolution?

### 1. **Sesiones de WhatsApp**

Cuando escaneas el QR Code, Evolution guarda:

```sql
-- Ejemplo de tabla de sesiones (simplificado)
CREATE TABLE sessions (
    id UUID PRIMARY KEY,
    instance_name VARCHAR(255) UNIQUE NOT NULL,
    session_data JSONB NOT NULL,  -- Credenciales encriptadas
    qr_code TEXT,                  -- Último QR generado
    status VARCHAR(50),            -- connected | disconnected | qr
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**Campos importantes**:
- `session_data`: Tokens de autenticación de WhatsApp (encriptados)
- `qr_code`: QR Code en formato base64
- `status`: Estado actual de la conexión

### 2. **Instancias**

Cada número de WhatsApp es una **instancia**:

```sql
CREATE TABLE instances (
    id UUID PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,  -- ej: "sciencebot-production"
    phone_number VARCHAR(20),
    webhook_url TEXT,                   -- URL para webhooks
    webhook_events JSONB,               -- ["messages.upsert", "connection.update"]
    settings JSONB,                     -- Configuraciones específicas
    created_at TIMESTAMP
);
```

### 3. **Mensajes (Opcional)**

Si Evolution está configurado para guardar mensajes:

```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    instance_id UUID REFERENCES instances(id),
    remote_jid VARCHAR(255),        -- Número de destino
    message_id VARCHAR(255),        -- ID de WhatsApp
    message_type VARCHAR(50),       -- text | image | audio
    content TEXT,
    timestamp BIGINT,
    from_me BOOLEAN,
    status VARCHAR(20)              -- sent | delivered | read
);
```

---

## PostgreSQL en Railway

En el proyecto, PostgreSQL está desplegado como un **servicio separado** en Railway:

```mermaid
graph LR
    A[Evolution API<br/>Service] -->|Connection| B[(PostgreSQL<br/>Service)]

    subgraph Railway Project
        A
        B
    end

    style A fill:#FF6B6B
    style B fill:#336791
```

### Variables de Entorno

Evolution API se conecta a PostgreSQL usando:

```bash
# Variables internas de Evolution API
DATABASE_URL=postgresql://postgres:password@postgres.railway.internal:5432/evolution
DATABASE_PROVIDER=postgresql
```

**Formato de DATABASE_URL**:
```
postgresql://[usuario]:[password]@[host]:[puerto]/[database]
```

### Ventajas de PostgreSQL en Railway

1. **Backups automáticos**: Railway hace backup diario
2. **Escalabilidad**: Puedes aumentar recursos fácilmente
3. **SSL/TLS**: Conexión encriptada por defecto
4. **Monitoreo**: Railway muestra métricas de uso
5. **Variables inyectadas**: Railway configura automáticamente

---

## PostgreSQL vs Otras Bases de Datos

| Característica | PostgreSQL | MySQL | SQLite |
|----------------|------------|-------|--------|
| **Tipo** | Relacional | Relacional | Relacional embebida |
| **Complejidad** | Media-Alta | Media | Baja |
| **Performance** | Excelente | Muy buena | Limitada |
| **Escalabilidad** | Alta | Alta | Baja |
| **ACID** | Completo | Completo | Limitado |
| **JSON Support** | JSONB (nativo) | JSON (básico) | JSON (texto) |
| **Mejor para** | Apps complejas | Web apps | Apps pequeñas |

### ¿Por qué PostgreSQL y no MongoDB para Evolution?

Evolution API necesita **transacciones ACID** y **relaciones complejas**:

❌ **MongoDB**:
- No garantiza ACID en todas las operaciones
- Difícil modelar relaciones instancias ↔ sesiones ↔ mensajes

✅ **PostgreSQL**:
- ACID completo (importante para sesiones de WhatsApp)
- Foreign keys para integridad referencial
- Transacciones complejas (actualizar sesión + guardar mensaje)

---

## Consultas Típicas de Evolution API

### 1. Obtener Sesión Activa

```sql
SELECT session_data, status
FROM sessions
WHERE instance_name = 'sciencebot-production'
AND status = 'connected';
```

### 2. Actualizar Estado de Conexión

```sql
UPDATE sessions
SET status = 'connected',
    updated_at = NOW()
WHERE instance_name = 'sciencebot-production';
```

### 3. Guardar Nuevo Mensaje

```sql
INSERT INTO messages (
    id, instance_id, remote_jid, message_id,
    content, timestamp, from_me
)
VALUES (
    gen_random_uuid(),
    (SELECT id FROM instances WHERE name = 'sciencebot-production'),
    '51999999999@s.whatsapp.net',
    '3EB0123456789ABCDEF',
    '¿Cuánto cuesta la matrícula?',
    1698765432,
    false
);
```

---

## Rendimiento y Optimización

### Índices Importantes

Evolution API probablemente tiene estos índices:

```sql
-- Búsqueda rápida por nombre de instancia
CREATE INDEX idx_sessions_instance_name ON sessions(instance_name);

-- Búsqueda por estado
CREATE INDEX idx_sessions_status ON sessions(status);

-- Mensajes por instancia
CREATE INDEX idx_messages_instance_id ON messages(instance_id);

-- Mensajes por timestamp (orden cronológico)
CREATE INDEX idx_messages_timestamp ON messages(timestamp DESC);
```

### JSONB para Flexibilidad

PostgreSQL tiene **JSONB** (JSON binario), perfecto para:

```sql
-- Guardar webhook events como JSON
UPDATE instances
SET webhook_events = '["messages.upsert", "connection.update"]'::jsonb
WHERE name = 'sciencebot-production';

-- Query dentro de JSONB
SELECT * FROM instances
WHERE webhook_events @> '["messages.upsert"]'::jsonb;
```

---

## Seguridad

### 1. Encriptación de Sesiones

Las credenciales de WhatsApp están **encriptadas** en PostgreSQL:

```sql
-- session_data está encriptado con pgcrypto o similar
SELECT pgp_sym_decrypt(session_data::bytea, 'encryption_key')
FROM sessions
WHERE instance_name = 'sciencebot-production';
```

### 2. Conexión SSL/TLS

Railway fuerza SSL en conexiones:

```bash
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require
```

### 3. Credenciales Seguras

- Password complejo generado por Railway
- Acceso solo desde servicios internos de Railway
- No expuesto a internet público

---

## Backup y Recuperación

### Backup Automático en Railway

Railway hace backup de PostgreSQL:

- **Frecuencia**: Diaria
- **Retención**: 7 días (plan básico)
- **Ubicación**: S3 de Railway
- **Restore**: Desde el dashboard de Railway

### Backup Manual (Opcional)

```bash
# Exportar base de datos completa
pg_dump -h postgres.railway.internal \
        -U postgres \
        -d evolution \
        -F c \
        -f backup.dump

# Restaurar
pg_restore -h postgres.railway.internal \
           -U postgres \
           -d evolution \
           backup.dump
```

---

## Monitoreo

### Métricas Importantes en Railway

1. **Conexiones activas**: Número de conexiones abiertas
2. **Tamaño de base de datos**: Espacio usado en disco
3. **Query time**: Tiempo promedio de consultas
4. **CPU/Memoria**: Uso de recursos

### Consultas de Monitoreo

```sql
-- Ver conexiones activas
SELECT count(*) FROM pg_stat_activity;

-- Tamaño de base de datos
SELECT pg_size_pretty(pg_database_size('evolution'));

-- Tablas más grandes
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

---

## Relación con Redis

PostgreSQL y Redis trabajan juntos en Evolution API:

```mermaid
graph TB
    A[Evolution API Request]

    A -->|1. Check Cache| B[Redis]
    B -->|Cache HIT| C[Return Data]
    B -->|Cache MISS| D[PostgreSQL]
    D -->|Read Data| E[Store in Cache]
    E --> C

    style B fill:#DC382D
    style D fill:#336791
```

**División de responsabilidades**:

| Dato | PostgreSQL | Redis |
|------|-----------|-------|
| **Sesión de WhatsApp** | ✅ Persistencia | ✅ Cache |
| **Mensajes enviados** | ✅ Log permanente | ❌ |
| **Estado de conexión** | ✅ Backup | ✅ Tiempo real |
| **Cola de mensajes** | ❌ | ✅ Cola temporal |
| **Configuraciones** | ✅ Source of truth | ✅ Cache |

---

## PostgreSQL en el Contexto del Proyecto

```mermaid
graph TB
    A[Usuario WhatsApp] -->|Mensaje| B[Evolution API]
    B -->|Guarda mensaje| C[(PostgreSQL)]
    B -->|Webhook| D[FastAPI]
    D -->|Procesa| E[LangGraph]
    E -->|Busca info| F[(MongoDB Atlas)]
    E -->|Respuesta| D
    D -->|Send message| B
    B -->|Lee sesión| C

    style B fill:#FF6B6B
    style C fill:#336791
    style D fill:#4ECDC4
    style F fill:#FFD93D
```

**Nota importante**:
- **PostgreSQL** es usado por **Evolution API** (no por FastAPI directamente)
- **MongoDB Atlas** es usado por **FastAPI** para búsqueda de documentos
- Son bases de datos **independientes** con propósitos diferentes

---

## Ventajas de PostgreSQL en este Stack

1. **ACID**: Garantiza integridad de sesiones de WhatsApp
2. **Relacional**: Modela bien relaciones instancias-mensajes-webhooks
3. **JSONB**: Flexibilidad para datos semiestructurados
4. **Madurez**: Muy estable y confiable
5. **Railway**: Excelente integración

---

## Recursos Adicionales

- [PostgreSQL Official Docs](https://www.postgresql.org/docs/)
- [Railway PostgreSQL Guide](https://docs.railway.app/databases/postgresql)
- [JSONB in PostgreSQL](https://www.postgresql.org/docs/current/datatype-json.html)

---

## Próximos Pasos

- **[2.3 Redis](./2.3-redis.md)**: Cache complementario a PostgreSQL
- **[2.6 MongoDB Atlas](./2.6-mongodb-atlas.md)**: Base de datos del bot (diferente propósito)

**Volver al índice**: [README](../README.md)

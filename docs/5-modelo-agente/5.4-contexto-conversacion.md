# 5.4 Contexto Conversacional

## Context con phone_number

```python
# app/science_bot/agent/schemas.py

class Context(BaseModel):
    phone_number: str

    @classmethod
    def from_config(cls, config: RunnableConfig) -> "Context":
        return cls(phone_number=config.get("phone_number", "unknown"))
```

**Uso en el grafo**:
```python
# Al invocar
response = await graph.ainvoke(
    input={"messages": [...]},
    config={"phone_number": "51999999999"}  # ⭐ Context
)

# En el nodo chat
async def chat(state, config):
    context = Context.from_config(config)
    print(context.phone_number)  # "51999999999"
```

---

## Lista de Mensajes (BaseMessage)

```python
from langchain_core.messages import HumanMessage, AIMessage, ToolMessage

messages = [
    HumanMessage(content="¿Cuánto cuesta?"),
    AIMessage(content="", tool_calls=[...]),
    ToolMessage(content="S/ 350"),
    AIMessage(content="La matrícula cuesta S/ 350 soles.")
]
```

**Tipos**:
- `HumanMessage`: Del usuario
- `AIMessage`: Del modelo
- `ToolMessage`: Resultado de herramientas
- `SystemMessage`: System prompt

---

## Persistencia entre Llamadas

### Actualmente: Sin Persistencia

Cada mensaje es independiente:

```python
# Mensaje 1
await graph.ainvoke({"messages": [HumanMessage("Hola")]})
# → Responde "Hola"

# Mensaje 2 (NO RECUERDA el anterior)
await graph.ainvoke({"messages": [HumanMessage("¿Cuánto cuesta?")]})
# → NO tiene contexto de "Hola"
```

### Con Persistencia (Futuro)

```python
from langgraph.checkpoint.postgres import PostgresSaver

checkpointer = PostgresSaver(conn_string="postgresql://...")
graph = graph_builder.compile(checkpointer=checkpointer)

# Primera conversación
await graph.ainvoke(
    {"messages": [HumanMessage("Hola")]},
    config={"configurable": {"thread_id": "user-51999999999"}}
)

# Segunda conversación (RECUERDA la anterior)
await graph.ainvoke(
    {"messages": [HumanMessage("¿Cuánto cuesta?")]},
    config={"configurable": {"thread_id": "user-51999999999"}}
)
# → Tiene contexto de "Hola"
```

---

## Limitaciones Actuales

1. **Sin memoria entre mensajes**: Cada consulta es independiente
2. **Sin historial conversacional**: No recuerda conversaciones previas
3. **Sin contexto acumulado**: No puede hacer seguimiento de temas
4. **phone_number solo informativo**: No se usa para persistencia

---

## Mejoras Futuras

### 1. Memoria en PostgreSQL/Redis

```python
# Guardar historial en PostgreSQL
checkpointer = PostgresSaver(conn_string=DATABASE_URL)
graph = graph_builder.compile(checkpointer=checkpointer)
```

### 2. Contexto de Usuario

```python
class Context(BaseModel):
    phone_number: str
    school: str | None = None  # Recordar escuela del usuario
    name: str | None = None    # Nombre del usuario
```

### 3. Ventana de Conversación

```python
# Recordar últimos N mensajes
messages = state.messages[-10:]  # Últimos 10 mensajes
```

---

**Volver al índice**: [../README.md](../README.md)

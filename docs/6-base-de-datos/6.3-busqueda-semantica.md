# 6.3 Búsqueda Semántica

## Vector Search vs Búsqueda Tradicional

| Aspecto | Búsqueda Tradicional | Vector Search |
|---------|---------------------|---------------|
| **Método** | Keywords (LIKE, regex) | Similitud semántica |
| **Query** | "costo matrícula" | Embedding del texto |
| **Resultado** | Coincidencia exacta | Similitud de significado |
| **Ejemplo** | "costo" != "precio" | "costo" ≈ "precio" ✅ |

---

## Pipeline de $vectorSearch

```python
pipeline = [
    {
        "$vectorSearch": {
            "index": "default",
            "queryVector": query_embedding,
            "path": "embedding",
            "numCandidates": 50,
            "limit": 5,
            "filter": {"nombre_archivo": "Reglamento de Pagos 2024"}
        }
    },
    {
        "$project": {
            "_id": 1,
            "nombre_archivo": 1,
            "pagina": 1,
            "text": 1,
            "score": {"$meta": "vectorSearchScore"}
        }
    }
]
```

---

## numCandidates y limit

```python
"numCandidates": 50,  # Busca en 50 documentos candidatos
"limit": 5,           # Retorna top 5 resultados
```

**Recomendación**: `numCandidates = limit * 10`

---

## Filtros por Documento

```python
"filter": {"nombre_archivo": "Reglamento de Pagos 2024"}
```

Aplica filtro **antes** del Vector Search (más eficiente).

---

## Score de Relevancia

```python
"score": {"$meta": "vectorSearchScore"}
```

**Valores**: 0 a 1 (similitud de coseno)

**Ejemplo**:
```python
[
    {"text": "...", "score": 0.92},  # 92% similar
    {"text": "...", "score": 0.87},  # 87% similar
    {"text": "...", "score": 0.75},  # 75% similar
]
```

---

## Ejemplo Paso a Paso

### 1. Query del Usuario
```
"¿Cuánto cuesta la matrícula?"
```

### 2. Generar Embedding
```python
vector = await openai.aembed_query("¿Cuánto cuesta la matrícula?")
# [0.234, -0.567, ...]
```

### 3. Vector Search
```python
results = await mongo.aggregate([
    {"$vectorSearch": {
        "queryVector": vector,
        "limit": 5
    }}
])
```

### 4. Resultados Ordenados
```python
[
    PageMatch(text="...S/ 350 soles...", score=0.92, page=3),
    PageMatch(text="...costo matrícula...", score=0.87, page=5),
    ...
]
```

---

**Volver al índice**: [../README.md](../README.md)

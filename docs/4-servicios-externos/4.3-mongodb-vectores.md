# 4.3 MongoDB - Búsqueda Vectorial

## ¿Qué son los Embeddings?

**Embeddings** son representaciones numéricas (vectores) de texto que capturan su significado semántico.

```python
"¿Cuánto cuesta la matrícula?"
→ [0.234, -0.567, 0.123, ..., 0.891]  # 1536 números
```

**Textos similares** tienen **vectores similares**:

```python
"¿Cuánto cuesta la matrícula?"     → [0.23, -0.56, ...]
"¿Cuál es el precio de matrícula?" → [0.24, -0.55, ...]  # ✅ Similar

"¿Qué hora es?"                    → [-0.89, 0.12, ...]  # ❌ Diferente
```

---

## Vector Search en MongoDB

### Pipeline de $vectorSearch

```python
pipeline = [
    {
        "$vectorSearch": {
            "index": "default",
            "queryVector": query_embedding,  # [0.234, -0.567, ...]
            "path": "embedding",             # Campo con embeddings
            "numCandidates": 50,             # Candidatos preliminares
            "limit": 5,                      # Top 5 resultados
            "filter": {"nombre_archivo": "Reglamento de Pagos 2024"}
        }
    },
    {
        "$project": {
            "_id": 1,
            "nombre_archivo": 1,
            "pagina": 1,
            "text": 1,
            "score": {"$meta": "vectorSearchScore"}
        }
    }
]
```

---

## Similarity Score

MongoDB usa **similitud de coseno** para comparar vectores:

```python
similarity = cosine_similarity(vector_a, vector_b)
# Valores: 0 (opuesto) a 1 (idéntico)
```

**Ejemplo**:
```python
"¿Cuánto cuesta?" vs "El costo es..."  → score: 0.92 (92% similar)
"¿Cuánto cuesta?" vs "Calendario 2024" → score: 0.45 (45% similar)
```

---

## Pipeline de Agregación

```python
# app/core/mongo_db.py

async def search_best_matches(
    self, query: str, document_name: str, limit: int = 10
) -> SearchPagesResult:
    # 1. Generar embedding de la query
    query_embedding = await self.query_to_embedding(query)

    # 2. Vector Search
    pipeline = [
        {"$vectorSearch": {...}},
        {"$project": {...}}
    ]

    # 3. Ejecutar
    cursor = collection.aggregate(pipeline)

    # 4. Retornar resultados
    results = []
    async for doc in cursor:
        results.append(PageMatch(...))

    return SearchPagesResult(matches=results)
```

---

## Optimización

### numCandidates vs limit

```python
"numCandidates": 50,  # Busca en 50 documentos
"limit": 5,           # Retorna top 5
```

**Balance**:
- `numCandidates` alto = más precisión, más lento
- `numCandidates` bajo = más rápido, menos precisión

**Recomendación**: `numCandidates = limit * 10`

---

**Volver al índice**: [../README.md](../README.md)
